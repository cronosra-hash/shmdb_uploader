{% extends "base.html" %}

{% block title %}Person Search Results{% endblock %}

{% block content %}
<div class="page-wrapper">
  <h2 class="page-title">Search Results</h2>

  {% for person in people %}
  <div class="card fadeInUp">
    <div class="person-meta">
      {% if person.profile_path %}
      <img src="https://image.tmdb.org/t/p/w200{{ person.profile_path }}" alt="{{ person.name }}">
      {% endif %}
      <div class="person-details">
        <h3>{{ person.name }}</h3>
        <div class="person-stats">
          <p>
            Total Credits: {{ person.credits | length }} ·
            In DB: {{ person.credits | selectattr('exists') | list | length }} ·
            Not in DB: {{ person.credits | rejectattr('exists') | list | length }} ·
            Completion: {{
            (
            (person.credits | selectattr('exists') | list | length) /
            (person.credits | length if person.credits | length > 0 else 1) * 100
            ) | round(0)
            }}%
          </p>
        </div>
        <p><strong>Known for:</strong> {{ person.known_for_department }}</p>
        <p><strong>Birthday:</strong> {{ person.birthday or 'N/A' }}</p>
        <p><strong>Place of Birth:</strong> {{ person.place_of_birth or 'N/A' }}</p>
        {% if person.also_known_as %}
        <p><strong>Also Known As:</strong> {{ person.also_known_as | join(', ') }}</p>
        {% endif %}
        {% if person.biography %}
        <details>
          <summary>Biography</summary>
          <p>{{ person.biography }}</p>
        </details>
        {% endif %}
      </div>
    </div>

    {% if person.credits | length == 0 %}
    <span class="badge badge-warning">⚠ No credits found</span>
    {% endif %}
    <form method="get" class="filter-form">
      <input type="hidden" name="person_name" value="{{ person.name }}">
      <label for="type_filter">Show:</label>
      <select name="type" id="type_filter" onchange="this.form.submit()">
        <option value="all" {% if request.query_params.get('type')=='all' %}selected{% endif %}>All</option>
        <option value="movie" {% if request.query_params.get('type')=='movie' %}selected{% endif %}>Movies</option>
        <option value="tv" {% if request.query_params.get('type')=='tv' %}selected{% endif %}>TV Shows</option>
      </select>
    </form>
    {% set movies = person.credits | selectattr('media_type', 'equalto', 'movie') | list %}
    {% set tvshows = person.credits | selectattr('media_type', 'equalto', 'tv') | list %}
    <p class="credit-counts">
      {% set filter_type = request.query_params.get('type', 'all') %}

      {% if filter_type == 'movie' %}
    <p class="credit-counts">{{ movies|length }} movies</p>
    {% elif filter_type == 'tv' %}
    <p class="credit-counts">{{ tvshows|length }} TV shows</p>
    {% else %}
    <p class="credit-counts">{{ movies|length }} movies · {{ tvshows|length }} TV shows</p>
    {% endif %}
    </p>

    <details class="credits-toggle" {% if person.credits | length> 0 %}open{% endif %}>
      <summary class="credits-summary">Credits</summary>
      <div class="credits-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Id</th>
              <th>Title</th>
              <th>Type</th>
              <th>Year</th>
              <th>Role</th>
              <th>In DB</th>
            </tr>
          </thead>
          <tbody>
            {% set filter_type = request.query_params.get('type', 'all') %}
            {% for credit in person.credits %}
            {% if filter_type == 'all' or credit.media_type == filter_type %}
            <tr>
              <td>{{ credit.id }}</td>
              <td>
                {{ credit.title or credit.name }}
                <span class="external-links">
                  {% if credit.exists %}
                  <a href="/title/{{ credit.media_type }}/{{ credit.id }}" title="Details">
                    <img src="/static/icons/shmdb-logo.png" alt="Details" width="16" height="16">
                  </a>
                  {% endif %}

                  {% if credit.imdb_id %}
                  <a href="https://www.imdb.com/title/{{ credit.imdb_id }}" target="_blank" rel="noopener">
                    <img src="/static/icons/imdb.svg" alt="IMDb" width="20" height="12">
                  </a>
                  {% endif %}

                  <a href="https://www.themoviedb.org/{{ credit.media_type }}/{{ credit.id }}" target="_blank"
                    rel="noopener" title="TMDb">
                    <img src="/static/icons/tmdb.svg" alt="TMDb" width="16" height="16">
                  </a>
                </span>
              </td>

              <td>{{ credit.media_type | capitalize }}</td>

              <td>
                {% if credit.release_date %}
                {{ credit.release_date[:4] }}
                {% elif credit.first_air_date %}
                {{ credit.first_air_date[:4] }}
                {% else %}
                N/A
                {% endif %}
              </td>

              <td>
                {% if credit.character %}
                {{ credit.character }}
                {% elif credit.job %}
                {{ credit.job }}
                {% else %}
                N/A
                {% endif %}
              </td>

              <td>
                <form method="post" action="/tmdb_search" class="action-form">
                  <input type="hidden" name="tmdb_id" value="{{ credit.id }}">
                  <input type="hidden" name="media_type" value="{{ credit.media_type }}">
                  <button type="submit" class="badge-btn">
                    {% if credit.exists %}
                    <span class="badge badge-success">✅ In DB</span>
                    {% else %}
                    <span class="badge badge-secondary">❌ Not in DB</span>
                    {% endif %}
                  </button>
                </form>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>
  </div>
  {% endfor %}
</div>
{% endblock %}